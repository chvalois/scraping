{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.8.3", "generated_at": "2024-07-12T03:01:17.497503Z", "invocation_id": "e66a7b55-7a41-4f5b-82ce-ffcd29c6e422", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-12T03:01:16.443662Z", "completed_at": "2024-07-12T03:01:16.454942Z"}, {"name": "execute", "started_at": "2024-07-12T03:01:16.455516Z", "completed_at": "2024-07-12T03:01:16.617800Z"}], "thread_id": "Thread-1", "execution_time": 0.17619585990905762, "adapter_response": {"_message": "SELECT 3454", "code": "SELECT", "rows_affected": 3454}, "message": "SELECT 3454", "failures": null, "unique_id": "model.scraping_dbt.src_ads", "compiled": true, "compiled_code": "WITH raw_ads AS (\n    SELECT * FROM \"scraping_db\".\"public\".\"ads\"\n    )\n\nSELECT \n    RIGHT(url, 6) AS ad_id,\n    url AS ad_url,\n    lieu AS ad_location,\n    /* CASE WHEN lieu = '-' THEN NULL ELSE REGEXP_SUBSTR(lieu, '^([^(]+)') END AS ad_city, /* Old Method */ */\n    /* CASE WHEN lieu = '-' THEN NULL ELSE REGEXP_SUBSTR(lieu, '\\(([^)]+)\\)') END AS ad_zipcode, /* Old Method */ */\n    /* CASE WHEN lieu = '-' THEN NULL ELSE REGEXP_EXTRACT(lieu, r'^([^(]+)') END AS ad_city, /* For GCP */ */\n    /* CASE WHEN lieu = '-' THEN NULL ELSE REGEXP_EXTRACT(lieu, r'\\(([^)]+)\\)') END AS ad_zipcode, /* For GCP */ */\n    SPLIT_PART(SPLIT_PART(url, '/', 5), '-', 2) AS ad_type,\n    SPLIT_PART(lieu, '(', 1) AS ad_city,\n    SPLIT_PART(SPLIT_PART(lieu, '(', 2), ')', 1) AS ad_zipcode,\n    surface AS ad_surface,\n    COALESCE(nb_chambres, 0) AS ad_nb_bedrooms,\n    /* IFNULL(nb_chambres, 0) AS ad_nb_bedrooms, /* For GCP */ */\n    nb_pieces AS ad_nb_rooms,\n    SUBSTRING(SPLIT_PART(url, '-', -2), 1, 2) AS ad_department,\n    CAST(ROUND(CAST(REPLACE(price, ' ', '') AS NUMERIC)) AS INTEGER) AS ad_price,\n    CAST(ROUND(CAST(REPLACE(prix_m2, ' ', '') AS NUMERIC)) AS INTEGER) AS ad_price_sqm,\n    /* CAST(REPLACE(price, ' ', '') AS INT64) AS ad_price, /* For GCP */ */\n    /* CAST(REPLACE(prix_m2, ' ', '') AS INT64) AS ad_price_sqm, /* For GCP */ */\n    tags AS ad_tags,\n    tag_1 AS ad_tag_1,\n    tag_2 AS ad_tag_2,\n    tag_3 AS ad_tag_3,\n    images_url AS ad_images_url,\n    date_scraped AS ad_date_scraped,\n    TO_DATE(date_publication, 'DD/mm/YYYY') AS ad_published_on,\n    /* PARSE_DATE(\"%d/%m/%Y\", date_publication) AS ad_published_on, /* For GCP */ */\n    created_at,\n    updated_at \n    /* CURRENT_TIMESTAMP() AS created_at,  /* For GCP */ */\n    /* CURRENT_TIMESTAMP() AS updated_at  /* For GCP */ */\nFROM\n    raw_ads", "relation_name": "\"scraping_db\".\"public\".\"src_ads\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-12T03:01:16.625338Z", "completed_at": "2024-07-12T03:01:16.629866Z"}, {"name": "execute", "started_at": "2024-07-12T03:01:16.630418Z", "completed_at": "2024-07-12T03:01:16.680370Z"}], "thread_id": "Thread-1", "execution_time": 0.05731987953186035, "adapter_response": {"_message": "SELECT 246", "code": "SELECT", "rows_affected": 246}, "message": "SELECT 246", "failures": null, "unique_id": "model.scraping_dbt.src_prix_m2", "compiled": true, "compiled_code": "WITH raw_prix_m2 AS (\n    SELECT * FROM \"scraping_db\".\"public\".\"prix_m2_commune\"\n    )\n\nSELECT \n    CASE \n        WHEN LENGTH(CAST(zipcode AS TEXT)) = 4 THEN CONCAT('0', CAST(zipcode AS TEXT))\n        ELSE CAST(zipcode AS TEXT)\n        /* WHEN LENGTH(CAST(zipcode AS STRING)) = 4 THEN CONCAT(\"0\", CAST(zipcode AS STRING))\n        ELSE CAST(zipcode AS STRING) /* For GCP */ */\n        END\n        AS zipcode,\n    city_name,\n    house_type,\n    CAST(prix_m2 AS INTEGER) AS prix_m2\nFROM\n    raw_prix_m2", "relation_name": "\"scraping_db\".\"public\".\"src_prix_m2\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-12T03:01:16.686155Z", "completed_at": "2024-07-12T03:01:16.690339Z"}, {"name": "execute", "started_at": "2024-07-12T03:01:16.690902Z", "completed_at": "2024-07-12T03:01:16.810671Z"}], "thread_id": "Thread-1", "execution_time": 0.12644052505493164, "adapter_response": {"_message": "SELECT 34540", "code": "SELECT", "rows_affected": 34540}, "message": "SELECT 34540", "failures": null, "unique_id": "model.scraping_dbt.dim_ads_images_url", "compiled": true, "compiled_code": "WITH src_ads AS (\n    SELECT * FROM \"scraping_db\".\"public\".\"src_ads\"\n    )\n\nSELECT \n    ad_id, \n    CASE WHEN ad_image_url = 'None' THEN ad_image_url ELSE REPLACE(ad_image_url, CHR(39), '') END AS ad_image_url    /* CHR(39) is ' */\nFROM\n    src_ads,\n    UNNEST(STRING_TO_ARRAY(REGEXP_REPLACE(ad_images_url, '^\\[|\\]$', ''), ', ')) AS ad_image_url\n    /* UNNEST(SPLIT(REGEXP_REPLACE(ad_images_url, r'^\\[|\\]$', ''), ', ')) AS ad_image_url /* For GCP */ */", "relation_name": "\"scraping_db\".\"public\".\"dim_ads_images_url\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-12T03:01:16.816388Z", "completed_at": "2024-07-12T03:01:16.820757Z"}, {"name": "execute", "started_at": "2024-07-12T03:01:16.821362Z", "completed_at": "2024-07-12T03:01:17.018923Z"}], "thread_id": "Thread-1", "execution_time": 0.20442700386047363, "adapter_response": {"_message": "SELECT 31909", "code": "SELECT", "rows_affected": 31909}, "message": "SELECT 31909", "failures": null, "unique_id": "model.scraping_dbt.dim_ads_tags", "compiled": true, "compiled_code": "WITH \nsrc_ads AS (\n    SELECT * FROM \"scraping_db\".\"public\".\"src_ads\"\n    ),\n\ntemp_tags AS (\nSELECT DISTINCT\n    ad_id, \n    CASE WHEN ad_tag = 'None' THEN ad_tag ELSE REPLACE(ad_tag, CHR(39), '') END AS ad_tag    /* CHR(39) is ' */\nFROM\n    src_ads,\n    UNNEST(STRING_TO_ARRAY(REGEXP_REPLACE(ad_tags, '^\\[|\\]$', ''), ', ')) AS ad_tag\n    /* UNNEST(SPLIT(REGEXP_REPLACE(ad_tags, r'^\\[|\\]$', ''), ', ')) AS ad_tag /* For GCP */ */\n\nWHERE \n    ad_tag != 'None' AND ad_tag != ' '\n\nUNION ALL\nSELECT ad_id, ad_tag_1 AS ad_tag FROM src_ads WHERE ad_tag_1 IS NOT NULL AND ad_tag_1 != 'None'\n\nUNION ALL\nSELECT ad_id, ad_tag_2 AS ad_tag FROM src_ads WHERE ad_tag_2 IS NOT NULL AND ad_tag_2 != 'None'\n\nUNION ALL\nSELECT ad_id, ad_tag_3 AS ad_tag FROM src_ads WHERE ad_tag_3 IS NOT NULL AND ad_tag_3 != 'None'\n)\n\nSELECT DISTINCT \n    ad_id, \n    ad_tag\nFROM\n    temp_tags\nORDER BY \n    ad_id, \n    ad_tag", "relation_name": "\"scraping_db\".\"public\".\"dim_ads_tags\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-12T03:01:17.024853Z", "completed_at": "2024-07-12T03:01:17.029453Z"}, {"name": "execute", "started_at": "2024-07-12T03:01:17.030041Z", "completed_at": "2024-07-12T03:01:17.100057Z"}], "thread_id": "Thread-1", "execution_time": 0.07725143432617188, "adapter_response": {"_message": "SELECT 3454", "code": "SELECT", "rows_affected": 3454}, "message": "SELECT 3454", "failures": null, "unique_id": "model.scraping_dbt.fct_ads_price_history", "compiled": true, "compiled_code": "WITH src_ads AS (\n    SELECT * FROM \"scraping_db\".\"public\".\"src_ads\"\n),\n\nduplicates AS (\n    SELECT\n        ad_id,\n        ROW_NUMBER() OVER (\n            PARTITION BY ad_id, ad_price\n            ORDER BY ad_published_on, updated_at DESC\n        ) AS update_order,\n\t\tad_published_on,\n        updated_at,\n\t\tad_price\n\tFROM\n        src_ads s\n),\n\nmax_updates_by_ad_id AS (\n\tSELECT \n\t\tad_id, MAX(update_order) AS nb_updates\n\tFROM \n\t\tduplicates d\n\tGROUP BY \n\t\tad_id\n)\n\nSELECT d.*, m.nb_updates FROM duplicates d\nLEFT JOIN max_updates_by_ad_id m ON d.ad_id = m.ad_id \nORDER BY d.ad_id, d.update_order ASC", "relation_name": "\"scraping_db\".\"public\".\"fct_ads_price_history\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-12T03:01:17.106008Z", "completed_at": "2024-07-12T03:01:17.110548Z"}, {"name": "execute", "started_at": "2024-07-12T03:01:17.111146Z", "completed_at": "2024-07-12T03:01:17.185120Z"}], "thread_id": "Thread-1", "execution_time": 0.08103680610656738, "adapter_response": {"_message": "SELECT 2928", "code": "SELECT", "rows_affected": 2928}, "message": "SELECT 2928", "failures": null, "unique_id": "model.scraping_dbt.src_ads_cleaned", "compiled": true, "compiled_code": "WITH src_ads AS (\n    SELECT * FROM \"scraping_db\".\"public\".\"src_ads\"\n),\n\nlatest_ads AS (\n    SELECT\n        ad_id,\n        MAX(updated_at) AS latest_updated_at\n    FROM\n        src_ads\n    GROUP BY\n        ad_id\n),\n\nid_duplicates AS (\n    SELECT\n        s.*\n    FROM\n        src_ads s\n    LEFT JOIN\n        latest_ads la\n    ON\n        s.ad_id = la.ad_id\n        AND s.updated_at = la.latest_updated_at\n    WHERE\n        la.ad_id IS NULL\n)\n\nSELECT * FROM src_ads\nWHERE (ad_id, updated_at) NOT IN (\n    SELECT \n        ad_id,\n\t\tupdated_at\n    FROM   \n        id_duplicates\n)", "relation_name": "\"scraping_db\".\"public\".\"src_ads_cleaned\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-12T03:01:17.191089Z", "completed_at": "2024-07-12T03:01:17.203572Z"}, {"name": "execute", "started_at": "2024-07-12T03:01:17.204185Z", "completed_at": "2024-07-12T03:01:17.405956Z"}], "thread_id": "Thread-1", "execution_time": 0.21706891059875488, "adapter_response": {"_message": "INSERT 0 4506", "code": "INSERT", "rows_affected": 4506}, "message": "INSERT 0 4506", "failures": null, "unique_id": "model.scraping_dbt.src_ads_cleaned_backup_incremental", "compiled": true, "compiled_code": "\n\nWITH src_ads AS (\n    SELECT * FROM \"scraping_db\".\"public\".\"src_ads\"\n),\n\nexisting_ads AS (\n    SELECT * FROM \"scraping_db\".\"public\".\"src_ads\"\n    WHERE True\n),\n\nnew_or_updated_ads AS (\n    SELECT\n        s.ad_id, \n        s.ad_url,\n        s.ad_city,\n        s.ad_zipcode,\n        s.ad_surface,\n        s.ad_nb_bedrooms,\n        s.ad_nb_rooms,\n        s.ad_price,\n        s.ad_price_sqm,\n        s.ad_date_scraped,\n        s.ad_published_on,\n        COALESCE(e.created_at, s.updated_at) AS created_at,\n        s.updated_at\n    FROM src_ads s\n    LEFT JOIN existing_ads e ON s.ad_id = e.ad_id\n    )\n\nSELECT * \nFROM new_or_updated_ads\n/*WHERE \n    NOT True           \n    OR ad_id IS NULL */", "relation_name": "\"scraping_db\".\"public\".\"src_ads_cleaned_backup_incremental\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-12T03:01:17.412262Z", "completed_at": "2024-07-12T03:01:17.417252Z"}, {"name": "execute", "started_at": "2024-07-12T03:01:17.417860Z", "completed_at": "2024-07-12T03:01:17.478158Z"}], "thread_id": "Thread-1", "execution_time": 0.06802678108215332, "adapter_response": {"_message": "SELECT 2928", "code": "SELECT", "rows_affected": 2928}, "message": "SELECT 2928", "failures": null, "unique_id": "model.scraping_dbt.dim_ads_details", "compiled": true, "compiled_code": "WITH src_ads_cleaned AS (\n    SELECT * FROM \"scraping_db\".\"public\".\"src_ads_cleaned\"\n)\n\nSELECT \n    ad_id,\n    ad_url,\n    ad_city,\n    ad_zipcode,\n    ad_nb_bedrooms,\n    ad_nb_rooms,\n    ad_date_scraped AS ad_last_date_scraped,\n    ad_published_on AS ad_last_published_on,\n    created_at,\n    updated_at\nFROM\n    src_ads_cleaned", "relation_name": "\"scraping_db\".\"public\".\"dim_ads_details\""}], "elapsed_time": 1.2187929153442383, "args": {"log_file_max_bytes": 10485760, "log_path": "/opt/airflow/scraping_dbt/logs", "cache_selected_only": false, "write_json": true, "log_format": "default", "select": [], "which": "run", "send_anonymous_usage_stats": true, "indirect_selection": "eager", "log_level_file": "debug", "partial_parse": true, "use_colors_file": true, "require_resource_names_without_spaces": false, "source_freshness_run_project_hooks": false, "empty": false, "partial_parse_file_diff": true, "populate_cache": true, "log_format_file": "debug", "enable_legacy_logger": false, "strict_mode": false, "show_resource_report": false, "printer_width": 80, "defer": false, "version_check": true, "project_dir": "/opt/airflow/scraping_dbt", "favor_state": false, "print": true, "introspect": true, "exclude": [], "log_level": "info", "static_parser": true, "quiet": false, "profiles_dir": "/opt/airflow/dbt_profiles", "use_colors": true, "warn_error_options": {"include": [], "exclude": []}, "vars": {}, "require_explicit_package_overrides_for_builtin_materializations": true, "macro_debugging": false, "invocation_command": "dbt run --profiles-dir /opt/airflow/dbt_profiles"}}